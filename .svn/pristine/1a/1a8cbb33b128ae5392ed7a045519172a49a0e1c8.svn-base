//使用窗口组件加载时注释下面的代码
$(document).ready(function() {
	yhgl_save.onLoad();
});
/**
 * <ol>
 * <li>date:13-11-24</li>
 * <li>editor:李强</li>
 * <li>创建文档</li>
 * <li>新增、修改参数</li>
 * <li>功能：用户管理功能</li>
 * </ol>
 */
var yhgl_save = (function() {
	// 私有属性
	var curSeg, formSave = "formSave", formSave_, winObj, winParam, anum=2,cc=0,psnum=4;
	var isCzryDmEditAble = false;
	// 是否是添加
	var bAdd = true;
	// 私有方法
	var setVal = function(tagID, val) {
		baseTools.byId(formSave_ + tagID).value = val;
	};

	var initLayout = function() {
		// 初始化页面UI
		formSave_ = formSave + "_";
		baseTools.setIdByName([ formSave ]);
		winObj = frameElement.api;
		winParam = winObj.data;
		bAdd = winParam.other.msg == '添加';
		$("#" + formSave_ + "channel_id").append('<option value ="'+winParam.other.upperchannel+'">'+winParam.other.upperchannelname+'</option>')
		/*//填充栏目模板下拉列表框
		baseTools.xhrAjax({
			url : "/contenttype/"+winParam.other.type_id,
			type : "GET",
			callback : function(jsonObj, xhrArgs) {
				switch (parseInt(jsonObj.code)) {
				// 查询操作返回标志
				case 0:
					curSeg.onBindData(jsonObj, xhrArgs);
					break;
				// 添加、更新以及状态更新操作返回标志
				case 1:
					alert(jsonObj.msg);
					curSeg.onCloseWin();
					break;
				// 删除操作返回标志
				case 2:
					alert(jsonObj.msg);
					break;
				default:
				}
			}
		});
		
		//填充内容模板下拉列表框
		baseTools.xhrAjax({
			url : "/contenttype/"+winParam.other.type_id,
			type : "GET",
			callback : function(jsonObj, xhrArgs) {
				switch (parseInt(jsonObj.code)) {
				// 查询操作返回标志
				case 0:
					curSeg.onBindData(jsonObj, xhrArgs);
					break;
				// 添加、更新以及状态更新操作返回标志
				case 1:
					alert(jsonObj.msg);
					curSeg.onCloseWin();
					break;
				// 删除操作返回标志
				case 2:
					alert(jsonObj.msg);
					break;
				default:
				}
			}
		});*/
		
		baseTools.xhrAjax({
			url: "/contenttype/queryNames",
			type: "GET",
			callback:[function(jsonObj){
				if(jsonObj){
					var ctypes = jsonObj.data.typenames.split(",");
					var opts = ''
						for(var i=0;i<ctypes.length;i=i+2){
							opts = opts + '<option value ="'+ctypes[i]+'">'+ctypes[i+1]+'</option>';	
						}
					opts = opts + '<option value ="" selected="selected">-请选择-</option>';
					$("#formSave_type_id").append(opts);
					}
			}]
		});
		
		if(winParam.other.leaf=="false"||(!winParam.other.leaf)){
			winObj.button({
				name : '保存',
				focus : true,
				callback : function() {
					curSeg.onSave();
					return false;
				}
			}, {
				name : '关闭'
			});
		}
		

		baseTools.checkFormLock([ formSave ]);
	};
	// 公有方法
	return {
		onLoad : function() {
			curSeg = yhgl_save;
			initLayout();
			if (!bAdd) {// 修改的时候进行查询
				curSeg.onQuery();
			} else {
				Validator.validate(baseTools.byId(formSave), 3);
			}

			// 删除组件释放内存
			$(window).unload(function() {
			});
		},
		// 查询数据
		onQuery : function() {
			baseTools.xhrAjax({
				url : "/channel/"+winParam.other.channel_id,
				type : "GET",
				callback : [ curSeg.pageFlowControl ]
			});
		},
		link : function(check) {
			if(!check){
				$('#formSave_urlspan').html('');
			}else{
				$('#formSave_urlspan').html('</br> url:<input type="text" id="link" name="link" value="" validatorrules="Require" msg0="url不能为空" maxlength="255" style="width:250px"/>');
			}
			 
		},
		// 保存数据
		onSave : function() {
			if($("#formSave_title").val()==""){
				alert("请填写标题!");
				return;
			}
			if($("#link")!=null && $("#link")!=undefined){
				if($("#link").val()==""){
					alert("请填写url!");
					return;
				}
			}
			if($("#formSave_release_date").val()==null||$("#formSave_release_date").val()==""||$("#formSave_release_date").val()==undefined){
				alert("请填写发布日期!");
				return;
			}
			if($("#formSave_type_id").val()==""){
				alert("请选择内容类型!");
				return;
			}
			if($("#formSave_txt").val()==""){
				alert("请填写内容!");
				return;
			}
			var allAttachments = "";
			var allpics = "";
			var allpicdes = "";
			$('input[type="file"]').each(function(){
				$(this).attr("disabled",true);;
    		  });
			$('#attachment input[type="text"]').each(function(){
				allAttachments = allAttachments + $(this).val()+",";
    		  });
			allAttachments = allAttachments.substring(0,allAttachments.length-1);
			$("#formSave_aSring").val(allAttachments);
			if($("#formSave_type_id").find("option:selected").text()=="图文"){
				$('#divpcs input[type="text"]').each(function(){
					allpics = allpics + $(this).val()+",";
	    		  });
				allpics = allpics.substring(0,allpics.length-1);
				$("#psSring").val(allpics);
				$('#divpcs textarea').each(function(){
					allpicdes = allpicdes + $(this).val()+",";
	    		  });
				allpicdes = allpicdes.substring(0,allpicdes.length-1);
				$("#psdesSring").val(allpicdes);
			}
			

			var url = "/content";
			
			var params = {};
			if (!bAdd) {
				params._method = "PUT";
			}
			baseTools.xhrAjax({
				url : url,
				forms : [ formSave ],
				params : params,
				callback : [ curSeg.pageFlowControl ]
			});
		},
		

		// 绑定数据
		onBindData : function(jsonObj, xhrArgs) {
//			$("#" + formSave_ + "CZRY_MC").attr("disabled", "true");
//			$("#" + formSave_ + "CZRY_DM").attr("disabled", "true");
			
			baseTools.bindFormData(formSave, jsonObj.data);
			if (jsonObj.data.is_blank==1)
				$("#" + formSave_ + "is_blank").attr("checked", "checked");
//			$("#" + formSave_ + "SKSBBH").val(winParam.other.SKSBBH);
//			$("#" + formSave_ + "KPR").val(winParam.other.KPR);
//			$("#" + formSave_ + "SKR").val(winParam.other.SKR);
//			$("#" + formSave_ + "FHR").val(winParam.other.FHR);
			if(winParam.other.leaf){
				$("#" + formSave_ + "channel_path").attr("readonly", "true");
				$("#" + formSave_ + "channel_name").attr("readonly", "true");
				$("#" + formSave_ + "content_path").attr("readonly", "true");
				$("#" + formSave_ + "title").attr("readonly", "true");
				$("#" + formSave_ + "keywords").attr("readonly", "true");
				$("#" + formSave_ + "description").attr("readonly", "true");
				$("#" + formSave_ + "priority").attr("readonly", "true");
				$("input[name='is_display']").attr("disabled", "disabled");
				$("#" + formSave_ + "is_blank").attr("onclick", "return false;");
				$("#" + formSave_ + "link").attr("readonly", "true");
			}
			Validator.validate(baseTools.byId(formSave), 3);
		},
		// 关闭窗口
		checkMedia : function(mname) {
			alert(cc+"  "+mname);
			cc+=1;
			
		},
		onCloseWin : function() {
			// 调用父窗口方法
//			winObj.opener.zzjggl.onQuery();
			winObj.opener.zzjggl.onQuery2();
			winObj.opener.zzjggl.refreshTree();
			
			setTimeout(function() {
				winObj.close();
			},100)
		},
		ajaxFileUpload : function(id,name,path) {
            var uploadUrl = id=="formSave_mupload"? '/contentupload/uploadfile2': id=="tupload"? '/contentupload/uploadfile3': '/contentupload/uploadfile';
			var of = $("#"+id);
			//检查是否选择了图片
			if(of.val()=="") {
				alert("请选择附件");
				return;
			}
			//将file移动至上传表单
			$("#fileContent").empty();
			$("#fileContent").append(of);
			
			var idloc = id+"_loc";
			if(id=='formSave_upload'){
				$("#"+idloc).append('<input type="file" id="formSave_upload" name="upload" />')
			}
			if(id.substring(0,1)=='a'){
				$("#"+idloc).append('<input type="file" id="'+id+'" name="upload" />')
			}
			if(id.substring(0,2)=='ps'){
				$("#"+idloc).append('<input type="file" id="'+id+'" name="upload" style="width:175px;"/>')
			}
			if(id=='formSave_mupload'){
				$("#"+idloc).append('<input type="file" id="formSave_mupload" name="mupload" />')
			}
			if(id=='tupload'){
				$("#"+idloc).append('<input type="file" id="tupload" name="tupload" />')
			}
			
			$("#fileContent").append($('<input type="hidden" name="name"/>').val(name));
			$("#fileContent").append($('<input type="hidden" name="path"/>').val(path));
			$("#uploadTempForm").attr("action", "http://cms.menhu.net:8080"+uploadUrl);
			$("#uploadTempForm").submit();
			
			

			
			
//			$.ajaxFileUpload({
//               url : "http://cms.menhu.net:8080"+uploadUrl, //用于文件上传的服务器端请求地址
//               secureuri : false, //是否需要安全协议，一般设置为false
//              fileElementId : id, //文件上传域的ID
//               dataType : 'json', //返回值类型 一般设置为json
//               crossDomain : true, //返回值类型 一般设置为json
//               success : function(data) { //服务器成功响应处理函数
//            	   data = jQuery.parseJSON(data.substring(data.indexOf('{'),data.indexOf('}')+1));
//                   if(data.code==0){
//                       $("#"+name).val(data.filename);
//                       $("#"+path).val(data.filepath);
//                       if(id=="formSave_mupload"){
//                    	   var mediaFileType = data.filename.substring(data.filename.lastIndexOf(".")+1).toUpperCase();
//                    	   var flag = true;
//                    	   $('input[name="media_type"]').each(function(){
//                    		    if($(this).val() == mediaFileType){
//                    		    	$(this).attr("checked","true");
//                    		    	flag = false;
//                    		    	return;
//                    		    }
//                    		  });
//                    	   if(flag){
//                    		   $('input[name="media_type"]').each(function(){
//                          		    if($(this).val() == "OTHERS"){
//                          		    	$(this).attr("checked","true");
//                          		    	return;
//                          		    }
//                          		  });
//                    	   }
//                       }
//                   }else if(data.code==-1){
//                       alert("上传失败 请重新上传！");
//                   }else{
//                       alert("上传出错 请重新上传！");
//                   }
//               },
//               error : function(data) { //服务器响应失败处理函数
//                   alert("服务异常 请重新上传!");           	   
//               }
//           });
				
		},
		attachmentAdd : function() {
			
			$("#attachment").append('<tr id="tr'+anum+'"><td><a href="javascript:yhgl_save.attachmentDel(\'tr'+anum+'\');">'+'删除'+'</a></td>'+
'<td> <input type="text" name="aName'+anum+'" id="aName'+anum+'" disabled="disabled" /></td><td><input type="text" name="aPath'+anum+'" id="aPath'+anum+'" disabled="disabled" /></td>'+
						'<td><span id="a'+anum+'_loc"><input  type="file" id="a'+anum +'" name="upload" /></span>'+
'<input type="button" value="上传" onclick="return yhgl_save.ajaxFileUpload(\'a'+anum+'\',\'aName'+anum+'\',\'aPath'+anum+'\');"/></td></tr>');
			anum+=1;
		},
		picsAdd : function() {
			$("#divpcs").append('<div id="divpcs'+psnum+'" style="float:left"><input type="hidden" name="psName'+psnum+'" id="psName'+psnum+'" disabled="disabled"/>'+
					'<input type="text" name="psPath'+psnum+'" id="psPath'+psnum+'" disabled="disabled"/>'+
					'<a href="javascript:yhgl_save.attachmentDel(\'divpcs'+ psnum +'\')" >删除</a></br>'+
					'<span id="psupload'+psnum+'_loc"><input  type="file" id="psupload'+psnum+'" name="upload" style="width:175px"/></span>'+
	'<input type="button" value="上传" onclick="return yhgl_save.ajaxFileUpload(\'psupload'+psnum+'\',\'psName'+psnum+'\',\'psPath'+psnum+'\');"/></br>'+
					'<textarea id="psdescription'+psnum+'" name="psdescription'+psnum+'" rows="3" style="width:205px" onfocus="yhgl_save.checkPicDes(this);"></textarea></div>');
			psnum+=1;
		},
		
		
		attachmentDel : function(aid) {
			$("#"+aid).remove();
		},
		checkPicDes : function(picDes) {
			if($(picDes).prev().prev().prev().prev().val()==""||$(picDes).prev().prev().prev().prev().val()==null||$(picDes).prev().prev().prev().prev().val()==undefined){
				$(picDes).attr("readonly","readonly");
			}else{
				$(picDes).removeAttr("readonly");
			}
		},
		
		TypepicAndPics : function(typevalue) {
	if($("#formSave_type_id").find("option:selected").text()=="图文"){
				$("#trcontent").before('<tr id="trtype"><td class="tdclass_view">类型图：</td><td class="tdclass_edit"  colspan="3">'+
	'<input type="text" name="tPath" id="tPath" disabled="disabled" style="width:240px"/><input type="hidden" name="tName" id="tName" disabled="disabled"/>'+
	'<span id="tupload_loc"><input type="file" id="tupload" name="tupload" /></span><input  type="button"  value="上传" onclick="return yhgl_save.ajaxFileUpload(\'tupload\',\'tName\',\'tPath\');"/> 注意：上传文件20M以内</td></tr>');
				$("#trcontent").before('<tr id="trpcs">'+
						'<td class="tdclass_view"  style="width:40px">图片集：</td>'+
						'<td class="tdclass_edit"  colspan="3">'+
							'<table id="pics">'+
							'<tr>'+
								'<td><input type="button" value="增加一张图片" onclick="yhgl_save.picsAdd();"/></td>'+
								'<td>注意：上传文件20M以内</td><input type="hidden" name="psSring" id="psSring" /><input type="hidden" name="psdesSring" id="psdesSring" />'+
							'</tr> </table>'+
							'<div id="divpcs">'+
								'<div id="divpcs1" style="float:left"><input type="hidden" name="psName1" id="psName1" disabled="disabled"/>'+
								'<input type="text" name="psPath1" id="psPath1" disabled="disabled"/>'+
								'<a href="javascript:yhgl_save.attachmentDel(\'divpcs1\')" >删除</a></br>'+
								'<span id="psupload1_loc"><input  type="file" id="psupload1" name="upload" style="width:175px"/></span>'+
								'<input  type="button"  value="上传" onclick="return yhgl_save.ajaxFileUpload(\'psupload1\',\'psName1\',\'psPath1\');"/></br>'+
								'<textarea id="psdescription1" name="psdescription1" rows="3" style="width:205px" onfocus="yhgl_save.checkPicDes(this);"></textarea>'+
							    '</div>'+
							    '<div id="divpcs2" style="float:left"><input type="hidden" name="psName2" id="psName2" disabled="disabled"/>'+
								'<input type="text" name="psPath2" id="psPath2" disabled="disabled"/>'+
								'<a href="javascript:yhgl_save.attachmentDel(\'divpcs2\')" >删除</a></br>'+
								'<span id="psupload2_loc"><input  type="file" id="psupload2" name="upload" style="width:175px"/></span>'+
								'<input  type="button"  value="上传" onclick="return yhgl_save.ajaxFileUpload(\'psupload2\',\'psName2\',\'psPath2\');"/></br>'+
								'<textarea id="psdescription2" name="psdescription2" rows="3" style="width:205px" onfocus="yhgl_save.checkPicDes(this);"></textarea>'+
							    '</div>'+
							    '<div id="divpcs3" style="float:left"><input type="hidden" name="psName3" id="psName3" disabled="disabled"/>'+
								'<input type="text" name="psPath3" id="psPath3" disabled="disabled"/>'+
								'<a href="javascript:yhgl_save.attachmentDel(\'divpcs3\')" >删除</a></br>'+
								'<span id="psupload3_loc"><input  type="file" id="psupload3" name="upload" style="width:175px"/></span>'+
								'<input  type="button"  value="上传" onclick="return yhgl_save.ajaxFileUpload(\'psupload3\',\'psName3\',\'psPath3\');"/></br>'+
								'<textarea id="psdescription3" name="psdescription3" rows="3" style="width:205px" onfocus="yhgl_save.checkPicDes(this);"></textarea>'+
							    '</div>'+
							'</div>'+
						'</td>'+
					'</tr>');
			}else{
				$("#trtype").remove();
				$("#trpcs").remove();
			}
		},
		/**
		 * 工具栏按钮操作
		 * 
		 * @param cmd
		 *            操作代码
		 */
		onToolbarClick : function(cmd) {
			switch (cmd) {
			case 1: // 添加类型
				curSeg.onSave();
				break;
			case 2: // 功能页面
				curSeg.onOpenSaveWin();
				break;
			case 3: // 打印页面
				break;
			case -1:
				curSeg.onCloseWin();
				break;
			default:
				alert("未知的操作命令!");
			}
		},
		/**
		 * 需要的时候可以覆盖该方法 在ajax调用中，在得到数据时调用该方法
		 */
		pageFlowControl : function(jsonObj, xhrArgs) {
			switch (parseInt(jsonObj.code)) {
			// 查询操作返回标志
			case 0:
				curSeg.onBindData(jsonObj, xhrArgs);
				break;
			// 添加、更新以及状态更新操作返回标志
			case 1:
				alert(jsonObj.msg);
				curSeg.onCloseWin();
				break;
			// 删除操作返回标志
			case 2:
				alert(jsonObj.msg);
				break;
			case -2:// 其它错误返回标志
				alert(jsonObj.msg);
				baseTools.hideMash();
				break;
			case 99:// 其它错误返回标志
				alert(jsonObj.msg);
				baseTools.hideMash();
				break;
			case -3:// cookie 失效请重新登录
				alert(jsonObj.msg);
				baseTools.gotoLogin();
				break;
			default:
			}
		}
	};
})();

Date.prototype.format = function(format) {
    var date = {
           "M+": this.getMonth() + 1,
           "d+": this.getDate(),
           "h+": this.getHours(),
           "m+": this.getMinutes(),
           "s+": this.getSeconds(),
           "q+": Math.floor((this.getMonth() + 3) / 3),
           "S+": this.getMilliseconds()
    };
    if (/(y+)/i.test(format)) {
           format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
    }
    for (var k in date) {
           if (new RegExp("(" + k + ")").test(format)) {
                  format = format.replace(RegExp.$1, RegExp.$1.length == 1
                         ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
           }
    }
    return format;
}